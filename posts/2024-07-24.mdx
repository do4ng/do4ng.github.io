nextë¡œ ê°œë°œí•˜ë‹¤ë³´ë©´ ì˜¤ë¥˜ê°€ ë°œìƒí•œ Typescript íŒŒì¼ì˜ ìœ„ì¹˜ë¥¼ ì •í™•íˆ ì½• ì°ì–´ì¤€ë‹¤.  
ê·¼ë° ìƒê°ì„ í•´ë³´ë©´ ë¸Œë¼ìš°ì €ëŠ” typescriptë¥¼ ì½ì„ ìˆ˜ ì—†ëŠ”ë° ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ typescriptíŒŒì¼ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí•œ ìœ„ì¹˜ë¥¼
ì¶”ì í•  ìˆ˜ ìˆì„ê¹Œë¼ëŠ” ê¶ê¸ˆì¦ì´ ë“ ë‹¤.

ê·¸ë˜ì„œ nodejsì—ì„œ íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ ë¿ë§Œ ì•„ë‹ˆë¼ ë²ˆë“¤ëœ íŒŒì¼ì—ì„œì˜ ì˜¤ë¥˜ íŠ¸ë ˆí‚¹í•˜ëŠ” ì½”ë“œë¥¼ ì‘ì„±í•´ë³´ì•˜ë‹¤.

## ì •ë‹µì€ ì†ŒìŠ¤ë§µ

ìš°ë¦¬ê°€ ë²ˆë“¤ëŸ¬ë¥¼ ì‚¬ìš©í•´ì„œ ì»´íŒŒì¼í–ˆì„ë•Œ ë‚˜ì˜¤ëŠ” `.map` íŒŒì¼ì„ ì†ŒìŠ¤ë§µì´ë¼ê³  í•˜ëŠ”ë°
ê±°ê¸°ì— ì›ë³¸ íŒŒì¼ì˜ ì •ë³´ê°€ ë‹´ê²¨ì ¸ìˆë‹¤ê³  í•œë‹¤.

## 1. ì˜¤ë¥˜ íŒŒì‹±

ê°€ì¥ ë¨¼ì € í•´ì•¼í•  ê²ƒì€ ì˜¤ë¥˜ê°€ ë°œìƒí•œ javascript íŒŒì¼ì˜ ìœ„ì¹˜ë¥¼ ì°¾ëŠ” ê²ƒì´ì˜€ë‹¤.

```ts
// lib/index.ts
function parseError(err: Error) {
  const st = err.stack?.split('\n').slice(1);
  return st?.map((stack) => {
    stack = stack.slice(7);
    const $ = {
      at: '',
      loc: '',
    };

    $.loc = (/\([^)]*\)/.exec(stack) || [])[0] || '';
    $.at = stack.replace($.loc, '');

    return $;
  });
}

export { parseError };
```

```js
console.log(parseError(new Error('aaa')));
```

ê°„ë‹¨í•œ ì˜¤ë¥˜ë¥¼ ì¶œë ¥í•´ë³´ë©´

```json
[
  {
    "at": "Object.<anonymous> ",
    "loc": "(D:\\error-tracking\\dist\\parse.js:38:15)"
  },
  {
    "at": "Module._compile ",
    "loc": "(node:internal/modules/cjs/loader:1241:14)"
  }
  // ...
]
```

ì›í•˜ëŠ” ê²°ê³¼ê°€ ë‚˜ì˜¨ë‹¤. ìœ„ íŒŒì‹±ëœ ì—ëŸ¬ ë°°ì—´ì˜ ì²« ë²ˆì§¸ê°€ ì›ë˜ ìœ„ì¹˜ë¥¼ ì°¾ëŠ” ë° ì¤‘ìš”í•œ ì—´ì‡ ê°€ ë  ê²ƒì´ë‹¤.

```ts
const stacks = parseError(err);
const occured = stacks[0].loc.slice(1, -1);
const sliced = occured.split(':');

const column = sliced.pop();
const line = sliced.pop();

const trace = {
  filename: occured,
  line: Number(line),
  column: Number(column),
};
```

ì´ë ‡ê²Œ í•˜ë©´ ì˜¤ë¥˜ê°€ ë°œìƒí•œ íŒŒì¼, í–‰, ì—´ê¹Œì§€ ë‹¤ ì¶”ì¶œëœë‹¤.

ì´ì œ ëª¨ë“  ì¤€ë¹„ëŠ” ëë‚¬ë‹¤. sourcemapì„ í•´ì„í•˜ê³  í•´ì„ëœ sourcemapì—ì„œ ì›í•˜ëŠ” ê°’ë§Œ ì–»ìœ¼ë©´ ëœë‹¤.

## 2. sourcemap ì»´íŒŒì¼í•˜ê¸°

[npm](https://www.npmjs.com/package/source-map)ì—ì„œ ì•„ì£¼ ì¢‹ì€ íŒ¨í‚¤ì§€ë¥¼ ì°¾ì•˜ë‹¤.

ê·¸ëƒ¥ ì†ŒìŠ¤ë§µ, í–‰, ì—´ë§Œ ë„£ìœ¼ë©´ ìœ„ì¹˜ë¥¼ ì°¾ì•„ì£¼ëŠ” íŒ¨í‚¤ì§€ì´ë‹¤.

ê·¸ë ‡ê²Œ ì™„ì„±í•œ ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤

```ts
// src/parse.ts
import { existsSync, readFileSync } from 'fs';
import { join, dirname } from 'path';
import { SourceMapConsumer } from 'source-map';

import { parseError } from '~/lib/index';

async function parse(err: Error, map?: string) {
  const stacks = parseError(err);
  const occured = stacks[0].loc.slice(1, -1);
  const sliced = occured.split(':');

  const column = sliced.pop();
  const line = sliced.pop();

  const trace = {
    filename: occured,
    line: Number(line),
    column: Number(column),
  };

  if (!existsSync(map)) {
    throw new Error(".map file desn't exist");
  }

  const sourcemapRaw = JSON.parse(readFileSync(map, 'utf-8'));

  const sourcemap = new SourceMapConsumer(sourcemapRaw);

  const result = (await sourcemap).originalPositionFor(trace);
  const target = join(dirname(sliced.join(':')), result.source);

  const errorFile = readFileSync(target, 'utf-8').split('\n');
  const errorLine = errorFile[result.line - 1];

  stacks.unshift({
    at: '',
    loc: `${target}:${result.line}:${result.column}`,
  });

  return { line: errorLine, originalFile: errorFile, stacks };
}

async function emit(e: Error, map: string) {
  const parsed = await parse(e, map);
  console.log(e.message);
  console.log(`> ${parsed.line} (at ${parsed.stacks[0].loc})`);
}

export { parse, emit };
```

ì´ì œ ì˜ ì‘ë™í•˜ëŠ”ì§€ë§Œ ë³´ì.

```ts
import { emit } from './parse';

try {
  const name: string = 'ğŸ’';

  throw new Error(`Hello ${name}`);
} catch (e) {
  emit(e, './dist/index.js.map');
}
```

```bash
D:\error-tracking> node dist/index.js
```

```txt
Hello ğŸ’
 (at D:\error-tracking\src\index.ts:6:8)
```

ì™„ë²½í•˜ë‹¤.

ì›ë˜ê°™ì•˜ìœ¼ë©´ ì˜¤ë¥˜ê°€ ë°œìƒí•œ ê³³ì— ê°€ë©´ ì•Œì•„ë³¼ ìˆ˜ ì—†ì„ì •ë„ë¡œ ì••ì¶•ëœ ì½”ë“œë°–ì— ì•ˆë³´ì˜€ëŠ”ë°  
ì´ì   ì˜¤ë¥˜ê°€ ë°œìƒí•œ ì§€ì ì„ ì›ë³¸ íŒŒì¼ì—ì„œ ì½• ì§‘ì–´ì„œ ë³´ì—¬ì¤€ë‹¤. ì•„ì£¼ ì¢‹ë‹¤.

ì†ŒìŠ¤: [https://github.com/do4ng/error-tracking](https://github.com/do4ng/error-tracking)
